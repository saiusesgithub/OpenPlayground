name: Auto-assign issue with limit and queue

on:
  issues:
    types: [opened, closed]

jobs:
  manage-assignments:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Handle issue assignment with limit
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue = context.payload.issue;
            const username = issue.user.login;

            // Get open issues assigned to this user
            const assignedRes = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} type:issue state:open assignee:${username}`
            });

            const activeCount = assignedRes.data.total_count;

            // Get unassigned open issues created by this user (oldest first)
            const pendingRes = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} type:issue state:open author:${username} no:assignee`,
              sort: "created",
              order: "asc"
            });

            const pendingIssues = pendingRes.data.items;

            // CASE 1: New issue opened
            if (context.payload.action === "opened") {
              if (activeCount < 4) {
                await github.rest.issues.addAssignees({
                  owner,
                  repo,
                  issue_number: issue.number,
                  assignees: [username]
                });

                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issue.number,
                  body: `âœ… Assigned to @${username}. You now have **${activeCount + 1}/4 active issues**. ðŸš€`
                });
              } else {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issue.number,
                  body: `â³ Hi @${username}, you already have **4 active issues assigned**.\n\nThis issue is added to your queue and will be auto-assigned when one of your current issues is closed.`
                });
              }
            }

            // CASE 2: Issue closed â†’ try assigning next pending issue
            if (context.payload.action === "closed") {
              if (activeCount < 4 && pendingIssues.length > 0) {
                const nextIssue = pendingIssues[0];

                await github.rest.issues.addAssignees({
                  owner,
                  repo,
                  issue_number: nextIssue.number,
                  assignees: [username]
                });

                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: nextIssue.number,
                  body: `ðŸŽ‰ @${username}, one of your issues was closed, so this queued issue is now assigned to you.\n\nYou now have **${activeCount + 1}/4 active issues**.`
                });
              }
            }
